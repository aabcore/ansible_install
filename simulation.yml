[
  {
    "hosts": "all",
    "become": true,
    "vars_files": ["vars/containers.yml"],
    "tasks": [
        {
          "name": "Install aptitude using apt",
          "apt": "name=aptitude state=latest update_cache=yes force_apt_get=yes",
        },
        {
          "name": "Install required system packages",
          "apt":
            {
              "name": "{{ item }}",
              "state": "latest",
              "update_cache": "yes",
              "cache_valid_time": 60,
            },
          "loop":
            [
              "apt-transport-https",
              "ca-certificates",
              "curl",
              "software-properties-common",
              "gnupg-agent",
              "python3-pip",
              "virtualenv",
              "python3-setuptools",
            ],
        },
        {
          "name": "Add Docker GPG apt Key",
          "apt_key":
            {
              "url": "https://download.docker.com/linux/ubuntu/gpg",
              "state": "present",
            },
        },
        {
          "name": "Add Docker Repository",
          "apt_repository":
            {
              "repo": "deb https://download.docker.com/linux/ubuntu focal stable",
              "state": "present",
            },
        },
        {
          "name": "Install required docker packages",
          "apt":
            {
              "name": "{{ item }}",
              "state": "latest",
              "update_cache": "yes",
              "cache_valid_time": 60,
            },
          "loop": ["docker-ce", "docker-ce-cli", "containerd.io"],
        },
        {
          "name": "Update apt and install docker-ce",
          "apt": "update_cache=yes name=docker-ce state=latest",
        },
        {
          "name": "Install Docker Module for Python",
          "pip": { "name": "docker" },
        },
        {
          "name": "DockerEngine Managed by systemd",
          "systemd": { "name": "docker", "enabled": "yes", "state": "started" },
        },
        # Start Simulation Pre-reqs
        # TODO Add nginx reverse proxy here
        {
          "name": "Pull nginx Reverse Proxy Docker images",
          "docker_image":
            {
              "name": "{{ item }}",
              "source": "pull",
              "state": "present",
            },
          "loop":
            [
              "{{nginx_proxy.fullname}}:{{nginx_proxy.tag}}",
              "{{letsencrypt_nginx_proxy_companion.fullname}}:{{letsencrypt_nginx_proxy_companion.tag}}",
            ],
        },
        {
          "name": "Add nginx to systemd",
          "template":
            {
              "src": "./nginx_systemd_conf.j2",
              "dest": "/etc/systemd/system/docker.{{nginx_proxy.shortName}}.service",
            },
            "notify": "nginx config change"
        },
        {
          "name": "Add letsencrypt_nginx_proxy_companion to systemd",
          "template":
            {
              "src": "./letsencrypt_companion_conf.j2",
              "dest": "/etc/systemd/system/docker.{{letsencrypt_nginx_proxy_companion.shortName}}.service",
            },
            "notify": "letsencrypt config change"
        },
        {
          "name": "Enabled nginx and letsencrypt by systemd",
          "systemd":
            {
              "name": "docker.{{item}}",
              "enabled": "yes",
              "state": "started",
            },
          "loop":
            [
              "{{nginx_proxy.shortName}}",
              "{{letsencrypt_nginx_proxy_companion.shortName}}",
            ],
            "notify": [
              "nginx config change", 
              "letsencrypt config change"
            ]
        },
        # Start Simulation Applications
        {
          "name": "Pull Application Docker images",
          "docker_image":
            {
              "name": "{{ item.fullName }}",
              "tag": "{{ item.tag }}",
              "source": "pull",
              "state": "present",
            },
          "loop": "{{ applications }}",
        },
        {
          "name": "Add App to systemd",
          "template":
            {
              "src": "./application_systemd_conf.j2",
              "dest": "/etc/systemd/system/docker.{{item.shortName}}.service",
            },
          "loop": "{{ applications }}",
          "notify": "systemd config change",
        },
        {
          "name": "Apps Enabled by systemd",
          "systemd":
            {
              "name": "docker.{{item.shortName}}",
              "enabled": "yes",
              "state": "started",
            },
          "loop": "{{ applications }}",
        },
      ],
    "handlers":
      [
        {
          "name": "Restart Apps",
          "systemd":
            {
              "name": "docker.{{item.shortName}}",
              "enabled": "yes",
              "state": "restarted",
              "daemon_reload": "yes",
            },
          "loop": "{{ applications }}",
          "listen": "systemd config change",
        },
        {
          "name": "Restart nginx",
          "systemd":
            {
              "name": "docker.{{nginx_proxy.shortName}}",
              "enabled": "yes",
              "state": "restarted",
              "daemon_reload": "yes",
            },
          "listen": "nginx config change",
        },
        {
          "name": "Restart Apps",
          "systemd":
            {
              "name": "docker.{{letsencrypt_nginx_proxy_companion.shortName}}",
              "enabled": "yes",
              "state": "restarted",
              "daemon_reload": "yes",
            },
          "listen": "letsencrypt config change",
        },
      ],
  },
]
